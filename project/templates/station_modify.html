{% extends "base.html" %}
{% load staticfiles %}
{% load filter %}

{% block head %}
    <script src="{% static "bower_components/bootstrap/dist/js/bootstrap.bundle.min.js" %}"></script>

    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/jquery.dataTables.min.css" %}">

    <script src={% static "bower_components/datatables.net/js/jquery.dataTables.min.js" %}></script>


    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/select.dataTables.min.css" %}">
    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/query.dataTables.min.css" %}">

    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/bootstrapvalidator/dist/css/bootstrapValidator.min.css" %}">
    <script src="{% static "bower_components/jquery-ui/jquery-ui.min.js" %}"></script>
    <script src="{% static "bower_components/bootstrapvalidator/dist/js/bootstrapValidator.min.js" %}"></script>
    <script src="{% static "bower_components/bootstrapvalidator/dist/js/language/en_US.js" %}"></script>

{% endblock %}


{% block css %}
    <style>
        input[type="text"].station_name,
        select.form-control {

            width: 350px;
        }

        input[type="text"].station_name:focus,
        select.form-control:focus {

            width: 350px;
        }

    </style>
{% endblock %}


{% block js %}
    <script>

        var project_name = '{{ project_name|escapejs }}';


        function table_clone() {
            return '<tr>' +
                '<td colspan="3">' +
                '<div class="form-group">' +
                '        <div class="input-group mb-3">' +
                '               <div style="margin-left: 10%"><input type="text" name="{{ part_number }}"' +
                '                                                 class="form-control station_name"' +
                '                                                 placeholder="Set station name" maxlength="255"' +
                '                                                 required="" id="id_station_name"> </div>' +
                '                <div class="input-group-append">' +
                '                    <button class="btn btn-outline-danger specific-st-remove" type="button"><i' +
                '                            class="fas fa-trash"></i>' +
                '                    </button>' +
                '                </div>' +
                '        </div>' +
                '</div>' +
                '</td>' +
                '</tr>'
        }


        $(function () {
            $(document).on("click", ".specific-st-remove", function () {

                var project_name = '{{ project_name|escapejs }}';
                var part_number = '{{ part_number|escapejs }}';
                var remove_tr = $(this).closest('tr');
                var station_name = remove_tr.find('input[name="{{ part_number }}"]').val();


                var rowCount = $("#part-table tbody").find('input').length;


                if (rowCount > 1) {
                    if (confirm("Are you sure to delete this row?")) {
                        $.ajax({
                            url: "/project/station_delete/", // the endpoint,commonly same url
                            type: 'POST',
                            data: {
                                csrfmiddlewaretoken: getCookie("csrftoken"),
                                "project_name": project_name,
                                "part_number": part_number,
                                "station_name": station_name
                            },

                            success: function (json) {

                                var remove_input = ($('input[name="' + part_number + '"]').last());
                                $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                remove_tr.remove();
                                $("#save_btn").removeAttr('disabled');


                            },
                            //處理失敗時會做的動作
                            error: function (xhr, errmsg, err) {
                                console.log("part number not in database");
                                var remove_input = ($('input[name="' + part_number + '"]').last());
                                $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                remove_tr.remove();
                                $("#save_btn").removeAttr('disabled');
                            }
                        });
                    }

                } else {
                    alert("You must provide at least one station name!")
                }


            });

        });

        $(document).ready(function () {


            //if had datas means posted ,even the result current ,will set the post value to all station input
            {% if datas %}
                var row = {{ datas|lookup:part_number|safe}}
                var rowCount = row.length;
                if (rowCount >= 1) {
                    for (i = 1; i <= rowCount; i++) {
                        $("#part-table tbody.{{ part_number }}").append(table_clone())
                    }
                }
                $("#part-table tbody.{{ part_number }}").each(function () {

                    var values = row;

                    $(this).find("input[name='{{ part_number }}']").each(function (i) {
                        $(this).val(values[i])

                    })

                });
            {% endif %}



            {% if datas and errors|trans_not %}
                $("#part-table tbody tr").find('div.input-group').append('<div class="input-group-append"><button type="button" class="btn btn-outline-primary select-script"><i class="fas fa-share"></i></button></div>');
                $(".select-script").click(function () {
                    var project_name = '{{ project_name }}';
                    var part_number = '{{ part_number }}';
                    var station_name = ($(this).closest("div.input-group.mb-3").find('input').val());
                    location.href = '/project/modify_script/' + project_name + '/' + part_number + '/' + station_name;
                });
            {% endif %}

            $("#set_station_form").bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'fas fa-check',
                    invalid: 'none',
                    validating: 'fas fa-sync-alt'
                },
                fields: {

            {{ part_number }}:
            {
                validators: {
                    notEmpty: {
                        message: 'The station name cannot be empty.'
                    }
                ,
                    regexp: {
                        regexp: /^\w+$/,
                            message
                    :
                        'The station name is incorrect.'
                    }
                ,
                    callback: {
                        message: 'The station name can not be repreated.',
                            callback
                    :

                        function (value, validator, $field) {
                            var station_array = [];
                            $("input[name='{{ part_number }}']").each(function () {
                                station_value = $(this).val();

                                if (station_value != "") {
                                    station_array.push(station_value);
                                }

                            });
                            var count = 0;
                            for (var i = 0; i < station_array.length; i++) {
                                count += (station_array[i] == value);
                            }

                            if (count > 1) {
                                return false
                            } else {
                                return true
                            }
                        }
                    }
                }
            }


        }
        })
            ;


            $("#part-table tbody").find(".st-add").each(function () {
                $(this).click(function (e) {
                    e.stopPropagation();
                    var part_number = ($(this).closest("tr").find(".part_number_col").text());
                    var append_target = $($(this).closest("tr").attr("data-target"));
                    $(append_target).append(table_clone(part_number));
                    var add_input = ($('input[name="' + part_number + '"]').last());
                    $('#set_station_form').bootstrapValidator('addField', add_input);
                    $("#save_btn").attr('disabled', 'disabled');

                })
            });


            $("#part-table tbody").find(".st-remove").each(function () {
                $(this).click(function (e) {

                    e.stopPropagation();
                    var append_target = $($(this).closest("tr").attr("data-target"));


                    var rowCount = append_target.find('input').length;
                    var remove_tr = append_target.find('tr').last();


                    if (rowCount > 1) {


                        var last_tr_station = remove_tr.find('input').val();
                        var part_number = (remove_tr.closest("tbody").attr("class").split(" ")[2]);

                        if (last_tr_station != "") {
                            if (confirm("Are you sure to delete this row?")) {
                                $.ajax({
                                    url: "/project/station_delete/", // the endpoint,commonly same url
                                    type: 'POST',
                                    data: {
                                        csrfmiddlewaretoken: getCookie("csrftoken"),
                                        "project_name": project_name,
                                        "part_number": part_number,
                                        "station_name": last_tr_station
                                    },

                                    success: function (json) {

                                        var remove_input = ($('input[name="' + part_number + '"]').last());
                                        $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                        remove_tr.remove();
                                        $("#save_btn").removeAttr('disabled');
                                    },

                                    //處理失敗時會做的動作
                                    error: function (xhr, errmsg, err) {
                                        console.log("part number not in database");
                                        var remove_input = ($('input[name="' + part_number + '"]').last());
                                        $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                        remove_tr.remove();
                                        $("#save_btn").removeAttr('disabled');
                                    }
                                });
                            }

                        } else {
                            var remove_input = ($('input[name="' + part_number + '"]').last());
                            $('#set_station_form').bootstrapValidator('removeField', remove_input);
                            remove_tr.remove();
                            $("#save_btn").removeAttr('disabled');
                        }

                    } else {
                        alert("You must provide at least one station name!")
                    }

                })
            });


        });
    </script>
{% endblock %}}
{% block body %}
    <h3>Modify [ {{ part_number }} ] station name </h3>
    <br>
    {% if errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>{{ errors }}</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    {% endif %}

    {% if susessful %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>{{ susessful }}</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    {% endif %}


    <form id="set_station_form" enctype="multipart/form-data" method="post" action="">{% csrf_token %}
        <table class="table  table-hover" id="part-table">
            <thead>
            <tr>
                <th style="width: 10%;text-align: center">Stations</th>
                <th>PartNumber</th>
                <th style="width:20%;text-align: center">Add/Del Station Name</th>
            </tr>
            </thead>


            <tbody>
            <tr class="clickable" data-toggle="collapse" data-target="#group-of-rows-0"
                aria-expanded="false"
                aria-controls="group-of-rows-1">
                <td style="text-align: center"><i class="fa fa-plus" aria-hidden="true"></i></td>
                <td class="part_number_col">{{ pn_instance.part_number }}</td>
                <td>
                    <div class="text-center">
                        <div class="btn-group">
                            <button type="button"
                                    class="btn btn-outline-success btn-xs  btn-md center-block st-add">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button"
                                    class=" btn btn-outline-danger btn-xs   btn-md center-block st-remove"><i
                                    class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                </td>

            </tr>
            </tbody>

            <tbody id="group-of-rows-0" class="collapse show {{ pn_instance.part_number }}">

            {% if datas %}

            {% else %}
                {% if st_list.count == 0 %}
                    <tr>
                        <td colspan="3">
                            <div class="form-group">
                                <div class="input-group mb-3">

                                    <div style="margin-left: 10%"><input type="text"
                                                                         name="{{ pn_instance.part_number }}"
                                                                         class="form-control station_name"
                                                                         placeholder="Set station name" maxlength="255"
                                                                         required="" id="id_station_name"
                                    ></div>


                                    <div class="input-group-append">
                                        <button class="btn btn-outline-danger specific-st-remove" type="button"><i
                                                class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>

                    </tr>
                {% endif %}


                {% for st in st_list %}
                    <tr>
                        <td colspan="3">
                            <div class="form-group">
                                <div class="input-group mb-3">

                                    <div style="margin-left: 10%"><input type="text"
                                                                         name="{{ pn_instance.part_number }}"
                                                                         class="form-control station_name"
                                                                         placeholder="Set station name" maxlength="255"
                                                                         required="" id="id_station_name"
                                                                         value="{{ st.station_name }}"></div>


                                    <div class="input-group-append">
                                        <button class="btn btn-outline-danger specific-st-remove" type="button"><i
                                                class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>

                    </tr>
                {% endfor %}

            {% endif %}

            </tbody>


        </table>

        <div class=text-center>
            <button class="btn btn-outline-primary" type="submit" id="save_btn"><i class="fas fa-save"></i> Save
            </button>
        </div>


    </form>


{% endblock %}
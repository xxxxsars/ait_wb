{% extends "base.html" %}
{% load staticfiles %}
{% load filter %}

{% block head %}



    <script src="{% static "bower_components/bootstrap/dist/js/bootstrap.bundle.min.js" %}"></script>





    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/jquery-treegrid/css/jquery.treegrid.css" %}">




    <script src="{% static "bower_components/jquery-treegrid/js/jquery.treegrid.js" %}"></script>



{% endblock %}



{% block css %}
    <style>

        .dataTables_filter, .dataTables_info {
            display: none;
        }

        h3 {
            text-align: center;
        }

        tbody tr:last-child {
            border-bottom: 1px solid #dee2e6;
        }

    </style>
{% endblock %}



{% block js %}


    <script>

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // project button action
        $(function () {
            $('#project_table tbody .prj-delete').each(function () {
                $(this).on('click', function (evt) {
                    $this = $(this);
                    var dtRow = $this.closest('tr');

                    if (confirm("Are you sure to delete this row?")) {

                        projectName = dtRow.find("td.project_name").text();


                        $.ajax({
                            url: "/project/delete/" + projectName, // the endpoint,commonly same url
                            type: 'DELETE',
                            data: {
                                csrfmiddlewaretoken: getCookie('csrftoken'),
                            },

                            success: function (json) {
                                //remove the sub part number and   station item
                                var compare_class = dtRow.attr("class").split(" ")[1].replace("treegrid-", "");
                                $("#project_table").find("tbody tr").each(function () {
                                    tr_array = $(this).attr("class").split(" ");

                                    var tr_line = $(this);
                                    $.each(tr_array, function (i, v) {
                                        if (v.indexOf(compare_class) > 0) {
                                            tr_line.remove()
                                        }
                                    })
                                });

                                //if didn't hava any project will show message
                                if ($("#project_table tbody tr").length == 0) {
                                    $("#project_table tbody").append('<tr><td colspan="5"><div class="text-center"> No data available in table</div></td></tr>')
                                }

                            },

                            //處理失敗時會做的動作
                            error: function (xhr, errmsg, err) {
                                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                            }
                        });


                    }
                });


            });


            $('#project_table tbody .prj-edit').each(function () {

                $(this).on('click', function (evt) {

                    var editRow = $(this).closest('tr');
                    project_name = editRow.find("td.project_name").text();

                    location.href = "/project/modify_project/" + project_name
                });
            });


        });


        // part number button action
        $(function () {
            $('#project_table tbody .pn-delete').each(function () {
                $(this).on('click', function (evt) {
                    $this = $(this);
                    var dtRow = $this.closest('tr');

                    cls_array = (dtRow.attr("class").split(" "));

                    project_name = cls_array[0];
                    part_number = cls_array[1];
                    {#console.log(project_name,part_number,cls_array)#}


                    if (confirm("Are you sure to delete this row?")) {


                        if (part_number == "DEFAULT") {

                            alert("'DEFAULT' can't be deleted!")

                        } else {
                            $.ajax({
                                url: "/project/pn_delete/", // the endpoint,commonly same url
                                type: 'POST',
                                data: {
                                    csrfmiddlewaretoken: getCookie("csrftoken"),
                                    "project_name": project_name,
                                    "part_number": part_number,
                                },

                                success: function (json) {
                                    //remove the sub station item
                                    var compare_class = dtRow.attr("class").split(" ")[2].replace("treegrid-", "");
                                    $("#project_table").find("tbody tr").each(function () {
                                        tr_array = $(this).attr("class").split(" ");

                                        var tr_line = $(this);
                                        $.each(tr_array, function (i, v) {
                                            if (v.indexOf(compare_class) > 0) {
                                                tr_line.remove()
                                            }
                                        })
                                    });
                                },

                                //處理失敗時會做的動作
                                error: function (xhr, errmsg, err) {
                                    console.log("part number not in database"); // provide a bit more info about the error to the console
                                }
                            });
                        }

                    }

                });


            });


            $('#project_table tbody .pn-edit').each(function () {

                $(this).on('click', function (evt) {

                    var editRow = $(this).closest('tr');
                    cls_array = (editRow.attr("class").split(" "));

                    project_name = cls_array[0];
                    part_number = cls_array[1];

                    location.href = "/project/modify_station/" + project_name + "/" + part_number;
                });
            });


        });


        // station  button action
        $(function () {
            $('#project_table tbody .st-delete').each(function () {
                $(this).on('click', function (evt) {
                    $this = $(this);
                    var dtRow = $this.closest('tr');

                    cls_array = (dtRow.attr("class").split(" "));

                    project_name = cls_array[0];
                    part_number = cls_array[1];
                    station_name = cls_array[2];

                    if (confirm("Are you sure to delete this row?")) {


                        $.ajax({
                            url: "/project/station_delete/", // the endpoint,commonly same url
                            type: 'POST',
                            data: {
                                csrfmiddlewaretoken: getCookie("csrftoken"),
                                "project_name": project_name,
                                "part_number": part_number,
                                "station_name": station_name
                            },

                            success: function (json) {
                                $this.closest('tr').remove();
                            },
                            //處理失敗時會做的動作
                            error: function (xhr, errmsg, err) {
                                console.log("part number not in database"); // provide a bit more info about the error to the console
                            }
                        });
                    }
                });


            });


            $('#project_table tbody .st-edit').each(function () {

                $(this).on('click', function (evt) {

                    var editRow = $(this).closest('tr');
                    cls_array = (editRow.attr("class").split(" "));
                    project_name = cls_array[0];
                    part_number = cls_array[1];
                    station_name = cls_array[2];
                    location.href = "/project/modify_script/" + project_name + "/" + part_number + "/" + station_name;

                });
            });


            $('#project_table tbody .st-download').each(function () {

                $(this).on('click', function (evt) {

                    var editRow = $(this).closest('tr');
                    cls_array = (editRow.attr("class").split(" "));
                    project_name = cls_array[0];
                    part_number = cls_array[1];
                    station_name = cls_array[2];
                    location.href = "/project/download_script/" + project_name + "/" + part_number + "/" + station_name;

                });
            });


        });

        $(document).ready(function () {

            $('.tree').treegrid({});
            $('.tree').treegrid('collapseAll');


        });
    </script>
{% endblock %}
{% block body %}
    <p style="text-align: center;font-weight:600;font-size: 26px;">[ {{ username |title }} ] Project</p>
    <br>






    <table class="tree table  table-hover" id="project_table">
        <thead>
        <tr>
            <th    {% if request.user.is_staff %} width="20%"  {% else %} width="30%" {% endif %}>Project Structure</th>
            {% if request.user.is_staff %}
                <th>Onwer User</th>
            {% endif %}
            <th>Create Date</th>
            <th>Create Time</th>
            <th style="text-align: right">Action</th>
        </tr>
        </thead>

        <tbody>


        {% if project_structure|length == 0 %}
            <tr>
                <td colspan="5">
                    <div class="text-center"> No data available in table</div>
                </td>
            </tr>

        {% else %}
            {% for prj in project_structure %}
                <tr class="{{ prj|lookup:"project_name" }} treegrid-{{ prj|lookup:"project_id" }} expanded">
                    <td class="project_name">{{ prj|lookup:"project_name" }}</td>
                    {% if request.user.is_staff %}
                        <td>{{ prj|lookup:"owner_user" }}</td>
                    {% endif %}
                    <td>
                        {{ prj|lookup:"date"|date:'Y-m-d' }}
                    </td>

                    <td>
                        {{ prj|lookup:"date"|date:'h:i A' }}
                    </td>
                    <td>
                        <div class="text-right">
                            <div class="btn-group">
                                <button type="button"
                                        class="btn btn-outline-primary btn-xs  btn-md center-block prj-edit"
                                        data-toggle="tooltip" data-placement="top"
                                        title="Edit Project">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button"
                                        class=" btn btn-outline-danger btn-xs   btn-md center-block prj-delete"
                                        data-toggle="tooltip" data-placement="top"
                                        title="Delete Project"><i
                                        class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                    </td>
                </tr>


                {% for pn in prj|lookup:"pn_list" %}
                    <tr class="{{ prj|lookup:"project_name" }} {{ pn|lookup:"part_number" }} treegrid-{{ pn|lookup:"pn_id" }} treegrid-parent-{{ prj|lookup:"project_id" }}">

                        <td {% if request.user.is_staff %} colspan="4"{% else %}
                                                           colspan="3" {% endif %}>{{ pn|lookup:"part_number" }}</td>
                        <td>

                            <div class="text-right">
                                <div class="btn-group">
                                    <button type="button"
                                            class="btn btn-outline-primary btn-xs  btn-md center-block pn-edit"
                                            data-toggle="tooltip" data-placement="top"
                                            title="Edit Part Number">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button"
                                            class=" btn btn-outline-danger btn-xs   btn-md center-block pn-delete"
                                            data-toggle="tooltip" data-placement="top"
                                            title="Delete Part Number"><i
                                            class="fas fa-trash"></i>
                                    </button>
                                </div>

                            </div>

                        </td>
                    </tr>



                    {% for st in pn|lookup:"st_list" %}

                        <tr class="{{ prj|lookup:"project_name" }} {{ pn|lookup:"part_number" }} {{ st|lookup:"station_name" }} treegrid-parent-{{ pn|lookup:"pn_id" }}">


                            <td  {% if request.user.is_staff %} colspan="4"{% else %}
                                                                colspan="3"  {% endif %}>{{ st|lookup:"station_name" }}

                            </td>

                            <td>
                                <div class="text-right">
                                    <div class="btn-group">
                                        <button type="button"

                                                {% if  st|lookup:"download" %}
                                                class=" btn btn-outline-success btn-xs   btn-md center-block st-download "
                                                {% else %}
                                                disabled
                                                class=" btn btn-outline-secondary btn-xs   btn-md center-block st-download "

                                                {% endif %}
                                                data-toggle="tooltip" data-placement="top"
                                                title="Download TestScript"><i
                                                class="fas fa-download"></i>
                                        </button>


                                        <button type="button"
                                                class="btn btn-outline-primary btn-xs  btn-md center-block st-edit"
                                                data-toggle="tooltip" data-placement="top"
                                                title="Edit Station">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button"
                                                class=" btn btn-outline-danger btn-xs   btn-md center-block st-delete "
                                                data-toggle="tooltip" data-placement="top"
                                                title="Delete Station"><i
                                                class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}

            {% endfor %}
        {% endif %}
        </tbody>
    </table>


{% endblock %}
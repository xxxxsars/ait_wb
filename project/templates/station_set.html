{% extends "base.html" %}
{% load staticfiles %}
{% load filter %}

{% block head %}
    <script src="{% static "bower_components/bootstrap/dist/js/bootstrap.bundle.min.js" %}"></script>

    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/jquery.dataTables.min.css" %}">

    <script src={% static "bower_components/datatables.net/js/jquery.dataTables.min.js" %}></script>


    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/select.dataTables.min.css" %}">
    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/datatables.net-dt/css/query.dataTables.min.css" %}">

    <link type="text/css" rel="stylesheet"
          href="{% static "bower_components/bootstrapvalidator/dist/css/bootstrapValidator.min.css" %}">
    <script src="{% static "bower_components/jquery-ui/jquery-ui.min.js" %}"></script>
    <script src="{% static "bower_components/bootstrapvalidator/dist/js/bootstrapValidator.min.js" %}"></script>
    <script src="{% static "bower_components/bootstrapvalidator/dist/js/language/en_US.js" %}"></script>


{% endblock %}


{% block css %}
    <style>
        input[type="text"].station_name,
        select.form-control {

            width: 350px;
        }

        input[type="text"].station_name:focus,
        select.form-control:focus {

            width: 350px;
        }


    </style>
{% endblock %}


{% block js %}
    <script>

        var project_name = '{{ project_name|escapejs }}';



        function table_clone(part_number) {
            return '<tr>' +
                '<td colspan="3">' +
                '<div class="form-group">' +
                '<div class="input-group mb-3">' +
                '<div style="margin-left: 10%"><input type="text" name="' + part_number + '"' + 'class="form-control station_name"' +
                'placeholder="Set station name" maxlength="255" required="" id="id_station_name"> </div>' +
                '<div class="input-group-append">' +
                '<button class="btn btn-outline-primary select-script" type="button" data-toggle="tooltip" data-placement="top" title="Select TestScrpit" disabled><i class="fas fa-share"></i>\</button>' +
                ' </div></div></div></td></tr>'
        }


        $(function () {
            $(document).on("click", ".select-script", function () {
                var part_number = ($(this).closest("tbody").attr("class").split(" ")[2]);
                var station_name = ($(this).closest("div.input-group.mb-3").find('input').val());
                location.href = '/project/select_script/' + project_name + '/' + part_number + '/' + station_name;

            });

        });

        $(document).ready(function () {

            //if had datas means posted ,even the result current ,will set the post value to all station input
            {% if datas %}
                {% for pn in datas|lookup:"all_pn" %}
                    var row = {{ datas|lookup:pn |safe}}
                    var rowCount = row.length;
                    if (rowCount > 1) {
                        for (i = 2; i <= rowCount; i++) {
                            $("#part-table tbody.{{ pn }}").append(table_clone('{{pn}}'))
                        }
                    }

                    $("#part-table tbody.{{ pn }}").each(function () {

                        var values = {{  datas|lookup:pn|safe }}

                            $(this).find("input[name='{{ pn }}']").each(function (i) {
                                $(this).val(values[i])

                            })

                    });
                {% endfor %}

            {% endif %}



            {% if datas and errors|trans_not %}
                $('input[name="station_name"]').attr("readonly", "readonly");

                $(".select-script").each(function () {
                    $(this).prop("disabled", false)
                });

            {% else %}
                $(".select-script").each(function () {


                    $(this).attr("disabled", "disabled")
                });
            {% endif %}



            $("#set_station_form").bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'fas fa-check',
                    invalid: 'none',
                    validating: 'fas fa-sync-alt'
                },
                fields: {
            {% for pn in pn_instances %}
                "{{ pn.part_number }}": {
                validators: {
                    notEmpty: {
                        message: 'The station name cannot be empty.'
                    }
                ,
                    regexp: {
                        regexp: /^\w+$/,
                            message
                    :
                        'The station name is incorrect.'
                    }
                ,
                    callback: {
                        message: 'The station name can not be repreated.',
                            callback
                    :

                        function (value, validator, $field) {
                            var station_array = [];
                            $("input[name='{{ pn.part_number }}']").each(function () {
                                station_value = $(this).val();

                                if (station_value != "") {
                                    station_array.push(station_value);
                                }

                            });
                            var count = 0;
                            for (var i = 0; i < station_array.length; i++) {
                                count += (station_array[i] == value);
                            }

                            if (count > 1) {
                                return false
                            } else {
                                return true
                            }
                        }
                    }
                }
            },
            {% endfor %}

        }
        })
            ;


            $("#part-table tbody").find(".st-add").each(function () {
                $(this).click(function (e) {
                    e.stopPropagation();
                    var part_number = ($(this).closest("tr").find(".part_number_col").text());
                    var append_target = $($(this).closest("tr").attr("data-target"));
                    $(append_target).append(table_clone(part_number));
                    var add_input = ($('input[name="' + part_number + '"]').last());
                    $('#set_station_form').bootstrapValidator('addField', add_input);
                    $("#save_btn").attr('disabled', 'disabled');
                })
            });


            $("#part-table tbody").find(".st-remove").each(function () {
                $(this).click(function (e) {

                    e.stopPropagation();
                    var append_target = $($(this).closest("tr").attr("data-target"));
                    var part_number = ($(this).closest("tr").find(".part_number_col").text());

                    var rowCount = append_target.find('input').length;
                    var remove_tr = append_target.find('tr').last();


                    if (rowCount > 1) {


                        var last_tr_station = remove_tr.find('input').val();
                        var part_number = (remove_tr.closest("tbody").attr("class").split(" ")[2]);

                        if (last_tr_station != "") {
                            if (confirm("Are you sure to delete this row?")) {
                                $.ajax({
                                    url: "/project/station_delete/", // the endpoint,commonly same url
                                    type: 'POST',
                                    data: {
                                        csrfmiddlewaretoken: getCookie("csrftoken"),
                                        "project_name": project_name,
                                        "part_number": part_number,
                                        "station_name": last_tr_station
                                    },

                                    success: function (json) {

                                        console.log(part_number)
                                        var remove_input = ($('input[name="' + part_number + '"]').last());
                                        $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                        remove_tr.remove();
                                        $("#save_btn").removeAttr('disabled');
                                    },


                                    error: function (xhr, errmsg, err) {
                                        console.log("part number not in database");
                                        var remove_input = ($('input[name="' + part_number + '"]').last());
                                        $('#set_station_form').bootstrapValidator('removeField', remove_input);
                                        remove_tr.remove();
                                        $("#save_btn").removeAttr('disabled');
                                    }
                                });
                            }

                        } else {
                            var remove_input = ($('input[name="' + part_number + '"]').last());
                            $('#set_station_form').bootstrapValidator('removeField', remove_input);
                            remove_tr.remove();
                            $("#save_btn").removeAttr('disabled');
                        }

                    } else {
                        alert("Your must to provide at least one station name.")
                    }

                })
            });


        });
    </script>
{% endblock %}}
{% block body %}
    <h3>Create [ {{ project_name }} ]</h3>
    <br>
    {% if errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>{{ errors }}</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    {% endif %}

    {% if susessful %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>{{ susessful }}</strong>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    {% endif %}


    <form id="set_station_form" enctype="multipart/form-data" method="post" action="">{% csrf_token %}
        <table class="table  table-hover" id="part-table">
            <thead>
            <tr>
                <th style="width: 10%;text-align: center">Stations</th>
                <th>PartNumber</th>
                <th style="width:20%;text-align: center">Add/Del Station Name</th>
            </tr>
            </thead>

            {% for pn in pn_instances %}
                <tbody>
                <tr class="clickable" data-toggle="collapse" data-target="#group-of-rows-{{ forloop.counter }}"
                    aria-expanded="false"
                    aria-controls="group-of-rows-1">
                    <td style="text-align: center"><i class="fa fa-plus" aria-hidden="true"></i></td>
                    <td class="part_number_col">{{ pn.part_number }}</td>
                    <td>
                        <div class="text-center">
                            <div class="btn-group">
                                <button type="button"
                                        class="btn btn-outline-success btn-xs  btn-md center-block st-add">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button"
                                        class=" btn btn-outline-danger btn-xs   btn-md center-block st-remove"><i
                                        class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                    </td>

                </tr>
                </tbody>

                <tbody id="group-of-rows-{{ forloop.counter }}" class="collapse show {{ pn.part_number }}">
                <tr>
                    <td colspan="3">
                        <div class="form-group">
                            <div class="input-group mb-3">

                                <div style="margin-left: 10%"><input type="text" name="{{ pn.part_number }}"
                                                                     class="form-control station_name"
                                                                     placeholder="Set station name" maxlength="255"
                                                                     required="" id="id_station_name"></div>

                                <div class="input-group-append">
                                    <button class="btn btn-outline-primary select-script" type="button"
                                            data-toggle="tooltip" data-placement="top"><i
                                            class="fas fa-share"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>

                </tbody>
            {% endfor %}
        </table>

        <div class=text-center>
            <button class="btn btn-outline-primary" type="submit" id="save_btn"><i class="fas fa-save"></i> Save
            </button>
        </div>


    </form>


{% endblock %}